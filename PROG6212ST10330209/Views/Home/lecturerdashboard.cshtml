@model List<Claim>
@{
    ViewData["Title"] = "Lecturer Dashboard";
}

<h2 class="text-center mb-4">Lecturer Claims Dashboard</h2>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (Model.Any())
{
    <div class="mb-5">
        <h4 class="mb-3">Your Claim History</h4>
        <table class="table table-striped table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Description</th>
                    <th>Hours Worked</th>
                    <th>Hourly Rate</th>
                    <th>Claim Amount</th>
                    <th>Status</th>
                    <th>Submission Date</th>
                    <th>Document</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var claim in Model)
                {
                    <tr>
                        <td>@claim.Description</td>
                        <td>@claim.HoursWorked</td>
                        <td>R @claim.HourlyRate.ToString("N2")</td>
                        <td>R @claim.ClaimAmount.ToString("N2")</td>
                        <td>
                            <span class="badge @(claim.Status == "Approved" ? "bg-success" : claim.Status == "Rejected" ? "bg-danger" : "bg-warning")">
                                @claim.Status
                            </span>
                        </td>
                        <td>@claim.SubmissionDate.ToString("MM/dd/yyyy")</td>
                        <td>
                            @if (!string.IsNullOrEmpty(claim.FileName))
                            {
                                <a href="@Url.Action("DownloadDocument", new { fileName = claim.FilePath })" class="btn btn-info btn-sm">
                                    View
                                </a>
                            }
                            else
                            {
                                <span class="text-muted">No document</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else
{
    <div class="alert alert-info text-center mb-4">
        <h4>No claims submitted yet</h4>
        <p>Submit your first claim using the form below.</p>
    </div>
}

<div class="card">
    <div class="card-body">
        <h4 class="card-title mb-4">Submit New Claim</h4>

        <!-- Enhanced Live Calculation Display -->
        <div class="row mb-4">
            <div class="col-md-8 offset-md-2">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h5 class="card-title">Automated Claim Calculation</h5>
                        <div class="row">
                            <div class="col-4">
                                <p class="mb-1"><strong>Hours:</strong></p>
                                <span id="displayHours" class="h5">0</span>
                            </div>
                            <div class="col-4">
                                <p class="mb-1"><strong>Rate:</strong></p>
                                <span id="displayRate" class="h5">R 0.00</span>
                            </div>
                            <div class="col-4">
                                <p class="mb-1"><strong>Total:</strong></p>
                                <h4 id="displayTotal" class="text-success">R 0.00</h4>
                            </div>
                        </div>
                        <div id="validationMessages" class="mt-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <form asp-action="SubmitClaim" method="post" enctype="multipart/form-data" id="claimForm">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Lecturer Name *</label>
                    <input type="text" class="form-control" id="lecturerName" name="LecturerName" required
                           oninput="validateForm()" />
                    <div class="invalid-feedback">Please enter your name.</div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Description of Work *</label>
                    <input type="text" class="form-control" id="description" name="Description" required
                           oninput="validateForm()" />
                    <div class="invalid-feedback">Please enter a description.</div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Hours Worked *</label>
                    <input type="number" class="form-control" id="hoursWorked" name="HoursWorked" min="1" max="100" required
                           oninput="calculateClaim(); validateForm()" />
                    <div class="invalid-feedback">Hours must be between 1 and 100.</div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Hourly Rate (R) *</label>
                    <input type="number" class="form-control" id="hourlyRate" name="HourlyRate" step="0.01" min="1" max="500" required
                           oninput="calculateClaim(); validateForm()" />
                    <div class="invalid-feedback">Hourly rate must be between R1 and R500.</div>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Supporting Document</label>
                <input type="file" class="form-control" id="supportingDocument" name="supportingDocument" accept=".pdf,.docx,.xlsx"
                       onchange="validateFile()" />
                <div class="form-text">Allowed formats: PDF, DOCX, XLSX (Max: 5MB)</div>
                <div id="fileValidation" class="invalid-feedback"></div>
            </div>
            <button type="submit" class="btn btn-success btn-lg w-100" id="submitButton" disabled>Submit Claim</button>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        function calculateClaim() {
            const hours = parseFloat(document.getElementById('hoursWorked').value) || 0;
            const rate = parseFloat(document.getElementById('hourlyRate').value) || 0;
            const total = hours * rate;

            // Update display
            document.getElementById('displayHours').textContent = hours;
            document.getElementById('displayRate').textContent = 'R ' + rate.toFixed(2);
            document.getElementById('displayTotal').textContent = 'R ' + total.toFixed(2);

            // Show validation messages
            const validationDiv = document.getElementById('validationMessages');
            let messages = [];

            if (hours > 40) {
                messages.push('⚠️ High hours detected: Consider breaking into multiple claims');
            }
            if (rate > 400) {
                messages.push('⚠️ High hourly rate: May require manager approval');
            }
            if (total > 10000) {
                messages.push('⚠️ Large claim amount: Additional verification may be needed');
            }

            validationDiv.innerHTML = messages.length > 0 ? messages.join('<br>') : '';
        }

        function validateForm() {
            const lecturerName = document.getElementById('lecturerName').value.trim();
            const description = document.getElementById('description').value.trim();
            const hours = parseFloat(document.getElementById('hoursWorked').value) || 0;
            const rate = parseFloat(document.getElementById('hourlyRate').value) || 0;
            const submitButton = document.getElementById('submitButton');

            // Basic validation
            const isValid = lecturerName.length > 0 &&
                           description.length > 0 &&
                           hours >= 1 && hours <= 100 &&
                           rate >= 1 && rate <= 500;

            submitButton.disabled = !isValid;

            // Update UI feedback
            const inputs = ['lecturerName', 'description', 'hoursWorked', 'hourlyRate'];
            inputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input.value.trim() === '') {
                    input.classList.add('is-invalid');
                } else {
                    input.classList.remove('is-invalid');
                    input.classList.add('is-valid');
                }
            });
        }

        function validateFile() {
            const fileInput = document.getElementById('supportingDocument');
            const fileValidation = document.getElementById('fileValidation');

            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const allowedExtensions = ['.pdf', '.docx', '.xlsx'];
                const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

                if (!allowedExtensions.includes(fileExtension)) {
                    fileInput.classList.add('is-invalid');
                    fileValidation.textContent = 'Only PDF, DOCX, and XLSX files are allowed.';
                    return false;
                }

                if (file.size > 5 * 1024 * 1024) {
                    fileInput.classList.add('is-invalid');
                    fileValidation.textContent = 'File size must be less than 5MB.';
                    return false;
                }

                fileInput.classList.remove('is-invalid');
                fileInput.classList.add('is-valid');
                fileValidation.textContent = '';
            }
            return true;
        }

        // Initialize calculation on page load
        document.addEventListener('DOMContentLoaded', function() {
            calculateClaim();
            validateForm();
        });

        // Auto-save form data to localStorage
        document.getElementById('claimForm').addEventListener('input', function() {
            const formData = {
                lecturerName: document.getElementById('lecturerName').value,
                description: document.getElementById('description').value,
                hoursWorked: document.getElementById('hoursWorked').value,
                hourlyRate: document.getElementById('hourlyRate').value
            };
            localStorage.setItem('claimFormData', JSON.stringify(formData));
        });

        // Load saved form data
        const savedData = localStorage.getItem('claimFormData');
        if (savedData) {
            const formData = JSON.parse(savedData);
            document.getElementById('lecturerName').value = formData.lecturerName || '';
            document.getElementById('description').value = formData.description || '';
            document.getElementById('hoursWorked').value = formData.hoursWorked || '';
            document.getElementById('hourlyRate').value = formData.hourlyRate || '';
            calculateClaim();
            validateForm();
        }
    </script>
}

<style>
    body {
        background-color: #f9f9f9;
        font-family: Arial, sans-serif;
        padding: 20px 0;
    }

    h2, h4 {
        color: #333;
    }

    .card {
        border: none;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    #displayTotal {
        font-weight: bold;
        color: #198754 !important;
    }

    .is-valid {
        border-color: #198754 !important;
    }

    .is-invalid {
        border-color: #dc3545 !important;
    }

    #validationMessages {
        font-size: 0.9em;
        color: #856404;
    }
</style>